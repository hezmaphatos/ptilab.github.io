<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Money Tracker</title>
  <link rel="stylesheet" href="css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
  <div class="d-flex flex-column flex-lg-row h-lg-full bg-surface-secondary">
    <div id="splash">
      <img id="splash-logo" src="img/loading.gif" alt="Loading...">
    </div>
    <div class="h-screen flex-grow-1 overflow-y-lg-auto">
        <header class="bg-surface-primary border-bottom pt-6">
            <div class="container-fluid">
                <div class="mb-npx">
                    <div class="row align-items-center">
                        <div class="col-sm-6 col-12 mb-4 mb-sm-0">
                            <h1 class="h2 mb-0 ls-tight">
                                Halo! <span id="userName"></span></h1>
                        </div>
                    <ul class="nav nav-tabs mt-4 overflow-x border-0">
                        <li class="nav-item ">
                            <a href="main.html" class="nav-link active">Main</a>
                        </li>
                        <li class="nav-item">
                            <a href="income.html" class="nav-link font-regular">Income</a>
                        </li>
                        <li class="nav-item">
                            <a href="outcome.html" class="nav-link font-regular">Outcome</a>
                        </li>
                        <li class="nav-item">
                          <a href="about.html" class="nav-link font-regular">About us</a>
                      </li>
                    </ul>
                </div>
            </div>
        </header>
        <main class="py-6 bg-surface-secondary">
            <div class="container-fluid">
                <div class="row g-6 mb-6">
                    <div class="col-xl-3 col-sm-6 col-12">
                        <div class="card shadow border-0">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col">
                                        <span class="h6 font-semibold text-muted text-sm d-inline-block mb-2">Balance</span> <span id="lowBalanceWarning" class="h6 font-semibold text-danger text-sm d-inline-block mb-2"></span>
                                        <span class="h3 font-bold mb-0" id="totalBalance"></span>
                                    </div>
                                    <div class="col-auto">
                                        <div class="icon icon-shape bg-warning text-white text-lg rounded-circle">
                                            <i class="bi bi-credit-card"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-sm-6 col-12">
                        <div class="card shadow border-0">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col">
                                        <span class="h6 font-semibold text-muted text-sm d-inline-block mb-2">Income</span>
                                        <span class="h3 font-bold mb-0"><h2 id="income" class="text-success">+Rp0</h2> </span>
                                    </div>
                                    <div class="col-auto">
                                        <div class="icon icon-shape bg-success text-white text-lg rounded-circle">
                                            <i class="bi bi-arrow-up"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-sm-6 col-12">
                        <div class="card shadow border-0">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col">
                                        <span class="h6 font-semibold text-muted text-sm d-inline-block mb-2">Outcome</span>
                                        <span class="h3 font-bold mb-0"><h2 id="outcome" class="text-danger">-Rp0</h2></span>
                                    </div>
                                    <div class="col-auto">
                                        <div class="icon icon-shape bg-danger text-white text-lg rounded-circle">
                                            <i class="bi bi-arrow-down"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="incomeSukses">
                  </div>
                  <div id="outcomeSukses"></div>
                <h5 class="mb-2">History Transaksi</h5>
                <div class="card shadow border-0 mb-7">
                    <div class="card-header">
                      <select name="kategori" id="showCategory" class="form-select d-inline-block" style="width: auto;" onchange="tampilkanData()">
                        <option value="all" selected>Kategori Transaksi</option>
                        <option value="showMakan">Makan</option>
                        <option value="showBermain">Bermain</option>
                        <option value="showEdukasi">Edukasi</option>
                        <option value="showBelanja">Belanja</option>
                        <option value="showLainnya">Lainnya</option>
                      </select>
                      <select name="tipeIO" id="tipeIO" class="form-select d-inline-block" style="width: auto;" onchange="tampilkanData()">
                        <option value="all" selected>All Type</option>
                        <option value="income">Income</option>
                        <option value="Outcome">Outcome</option>
                      </select>
                      <input type="text" id="searchTransactionName" class="form-control d-inline-block" placeholder="Search by name" style="width: auto; margin-top: 10px; float: right;" onkeyup="filterTransactions()">
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover table-nowrap">
                            <thead class="thead-light">
                                <tr>
                                    <th scope="col">Nama Transaksi</th>
                                    <th scope="col">Tipe</th>
                                    <th scope="col">Kategori</th>
                                    <th scope="col">Nominal</th>
                                    <th scope="col">Tanggal</th>
                                </tr>
                            </thead>
                            <tbody id="transactionList">
                            </tbody>
                        </table>
                    </div>

                    <div class="card-footer border-0 py-5">
                        <nav aria-label="Page navigation example">
                            <button class="btn btn-warning" onclick="clearTransactionHistory()">Clear History</button>
                        </nav>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('incomeSubmitted') === 'true') {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success mb-3';
        alertDiv.setAttribute('role', 'alert');
        alertDiv.textContent = 'Transaksi Sukses!';
        
        document.getElementById('incomeSukses').prepend(alertDiv);
        setTimeout(function() {
        alertDiv.remove();
        }, 2000);
        localStorage.removeItem('incomeSubmitted');
    }
    });

    document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('outcomeSubmitted') === 'true') {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger mb-3';
        alertDiv.setAttribute('role', 'alert');
        alertDiv.textContent = 'Transaksi Sukses!';
        
        document.getElementById('outcomeSukses').prepend(alertDiv);
        setTimeout(function() {
        alertDiv.remove();
        }, 2000);
        localStorage.removeItem('outcomeSubmitted');
    }
    });


    var username = localStorage.getItem("username");
        if (!username) {
            setTimeout(function() {
                window.location.href = 'index.html';
            }, 1000); 
        } else {
            document.getElementById('splash').style.display = 'none';
            document.getElementById("userName").innerText = username;
        }

        var transaction = JSON.parse(localStorage.getItem("transactions")) || [];


        function tampilkanData() {
          document.getElementById("searchTransactionName").value = "";
        var liatCategory = document.getElementById("showCategory").value;
        var transactionList = document.getElementById("transactionList");
        var transactions = JSON.parse(localStorage.getItem("transactions")) || [];
        var totalBalance = parseFloat(localStorage.getItem("balance")) || 0;
        var selectedType = document.getElementById("tipeIO").value.toLowerCase();
        var totalIncome = 0;
        var totalOutcome = 0;

        transactionList.innerHTML = '';

        var categoryMap = {
            showMakan: "makan",
            showBelanja: "belanja",
            showEdukasi: "edukasi",
            showBermain: "bermain",
            showLainnya: "lainnya"
        };

    transactions.forEach(function (transaction) {
        var filterCategory = liatCategory === "all" ? "all" : categoryMap[liatCategory];

        if ((filterCategory === "all" || transaction.category === filterCategory) &&
            (selectedType === "all" || transaction.type === selectedType)) {
            var listItem = document.createElement("tr");
            listItem.innerHTML = "<td style='font-size: 20px;'>" + transaction.name + "</td>" +
                "<td style='font-size: 20px;'>" + transaction.type + "</td>" +
                "<td style='font-size: 20px;'>" + transaction.category + "</td>" +
                "<td style='font-size: 20px;'>" + transaction.nominal + "</td>" +
                "<td style='font-size: 20px;'>" + transaction.date + "</td>";

            if (transaction.type === "income") {
                totalBalance += parseFloat(transaction.nominal);
                listItem.classList.add("text-success", "h1");
                totalIncome += parseFloat(transaction.nominal);
                document.getElementById("income").innerHTML = "<h2 class='text-success'>+Rp" + totalIncome.toLocaleString() + "</h2>";
            } else if (transaction.type === "outcome") {
                totalBalance -= parseFloat(transaction.nominal);
                listItem.classList.add("text-danger", "h1");
                totalOutcome += parseFloat(transaction.nominal);
                document.getElementById("outcome").innerHTML = "<h2 class='text-danger'>-Rp" + totalOutcome.toLocaleString() + "</h2>";
            }
            transactionList.appendChild(listItem);
        }
    });

    if (totalBalance <= 30000) {
        document.getElementById("lowBalanceWarning").innerHTML = "(Low Balance!)";
        document.getElementById("totalBalance").innerHTML = "<h2 class='text-danger'>Rp" + totalBalance.toLocaleString() + "</h2>";
        localStorage.setItem("totalBalance", totalBalance);
    } else {
        document.getElementById("lowBalanceWarning").innerHTML = "";
        document.getElementById("totalBalance").innerHTML = "<h2>Rp" + totalBalance.toLocaleString() + "</h2>";
        localStorage.setItem("totalBalance", totalBalance);
    }

    document.getElementById("clearHistoryBtn").addEventListener("click", function () {
        clearTransactionHistory();
        Swal.fire({
        position: "top-end",
        icon: "success",
        title: "Semua transaksi berhasil dihapus",
        showConfirmButton: false,
        timer: 1500
      });
    });

    document.getElementById("clearBalanceBtn").addEventListener("click", function () {
        clearTotalBalance();
    });

    document.querySelectorAll('.editButton').forEach(button => {
        button.addEventListener('click', function () {
            const transactionId = this.getAttribute('data-transaction-id');
            openModal(transactionId);
        });
    });
}

    function filterTransactions() {
        var input, filter, transactions, transactionList, listItem, i;
        input = document.getElementById("searchTransactionName");
        filter = input.value.toUpperCase();
        transactionList = document.getElementById("transactionList");
        transactions = transactionList.getElementsByTagName("tr");

        for (i = 0; i < transactions.length; i++) {
          listItem = transactions[i].getElementsByTagName("td")[0];
          if (listItem) {
            txtValue = listItem.textContent || listItem.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              transactions[i].style.display = "";
            } else {
              transactions[i].style.display = "none";
            }
          }
        }
    }

    function openModal(transactionId) {
        console.log("tolol");
      var transactions = JSON.parse(localStorage.getItem("transactions")) || [];
      var transaction = transactions.find(function(t) { return t.id === transactionId; });

        if (transaction) {
          alert("anjay");
          $('#exampleModal').modal('show');
          $('#exampleModal').find('#namaUpdate').val(transaction.name);
          $('#exampleModal').find('#nominalUpdate').val(transaction.nominal);
          $('#exampleModal').find('#tipeUpdate').val(transaction.type);
          $('#exampleModal').find('#kategoriUpdate').val(transaction.category);
        } else {
          alert("anana");
        }
    }

    function getBalance(){
        localStorage.setItem("totalBalance", totalBalance);
    }

      function clearTransactionHistory() {
        var i = 0;
        localStorage.removeItem("incomeCounter");
        localStorage.removeItem("outcomeCounter");
        localStorage.removeItem("transactions");
        document.getElementById("transactionList").innerHTML = "";
        localStorage.setItem("totalBalance", 0);
        updateTotalBalance();
        updateTotalIncome();
        updateTotalOutcome();
      }

      function clearTotalBalance() {
        localStorage.removeItem("transactions");
        localStorage.removeItem("balance");
        updateTotalBalance();
      }

      function updateTotalBalance() {
        totalBalance = 0;
        document.getElementById("totalBalance").innerHTML = "<h2 class='text-danger'>Rp0</h2>";
      };

      function updateTotalIncome() {
        totalIncome = 0;
        document.getElementById("income").innerHTML = "<h2 class='text-success'>+Rp0</h2>";
      };

      function updateTotalOutcome() {
        totalOutcome = 0;
        document.getElementById("outcome").innerHTML = "<h2 class='text-success'>-Rp0</h2>";
      };

      window.onload = function () {
        tampilkanData();
        getBalance();
        clearTransactionHistory();
      }
  </script>
</body>
</html>
